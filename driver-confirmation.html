<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="Driver dashboard - RideMate">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <title>Driver Confirmation - RideMate</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" href="/icons/icon-72x72.png">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">

    <link rel="stylesheet" href="style.css">
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow-x: hidden;
        }

        body {
            font-family: 'Inter', sans-serif;
        }

        /* Driver Confirmation Full-Width Layout */
        .driver-confirmation-main {
            display: flex;
            width: 100vw;
            height: 100vh;
            margin: 0;
            padding: 0;
            background: #ffffff;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.1);
        }

        .confirmation-content {
            flex: 1;
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            overflow-y: auto;
            background: #000000;
            color: #ffffff;
            position: relative;
            border-right: 1px solid #e5e7eb;
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }

        .content-header {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
            padding: 20px 50px;
            border-bottom: 1px solid #333;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }

        .content-body {
            flex: 1;
            padding: 60px 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .map-section {
            flex: 1;
            height: 100vh;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .map-overlay {
            position: absolute;
            top: 24px;
            left: 24px;
            right: 24px;
            background: rgba(0, 0, 0, 0.95);
            border-radius: 12px;
            padding: 18px 24px;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .route-info {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 15px;
            color: #ffffff;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: #ffffff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 32px;
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
        }

        .checkmark {
            color: #000000;
            font-size: 36px;
            font-weight: 900;
        }

        .confirmation-title {
            font-size: 48px;
            font-weight: 900;
            color: #ffffff;
            text-align: left;
            margin-bottom: 16px;
            line-height: 1.1;
            letter-spacing: -1px;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .confirmation-subtitle {
            font-size: 20px;
            color: #a0a0a0;
            text-align: left;
            margin-bottom: 40px;
            line-height: 1.4;
            font-weight: 400;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .privacy-notice {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 32px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .privacy-icon {
            font-size: 18px;
            background: #ffffff;
            color: #000000;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            box-shadow: none;
        }

        .privacy-notice p {
            margin: 0;
            font-size: 15px;
            color: #ffffff;
            font-weight: 400;
            line-height: 1.5;
        }

        .route-summary {
            background: #1a1a1a;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 32px;
            border: 1px solid #333;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .route-summary h3 {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 16px;
            text-align: left;
        }

        .route-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .route-point {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 8px 0;
        }

        .route-icon {
            font-size: 16px;
            width: 24px;
            text-align: center;
            flex-shrink: 0;
        }

        .route-start {
            color: #4CAF50;
        }

        .route-end {
            color: #f44336;
        }

        .route-text {
            font-size: 16px;
            color: #ffffff;
            font-weight: 400;
        }

        .route-line {
            height: 20px;
            width: 2px;
            background: #555;
            margin-left: 11px;
            border-radius: 1px;
        }

        .action-buttons {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
        }

        .btn {
            flex: 1;
            padding: 18px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            text-decoration: none;
            text-align: center;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: 'Inter', sans-serif;
            letter-spacing: 0.25px;
            text-transform: none;
        }

        .btn-primary {
            background: #ffffff;
            color: #000000;
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.15);
            border: none;
            font-weight: 600;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            background: #f8f9fa;
            box-shadow: 0 6px 20px rgba(255, 255, 255, 0.25);
            color: #000000;
        }

        .btn-secondary {
            background: transparent;
            color: #ffffff;
            box-shadow: none;
            border: 2px solid #444;
        }

        .btn-secondary:hover {
            background: #ffffff;
            color: #000000;
            border-color: #ffffff;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 255, 255, 0.15);
        }

        .notification-settings {
            margin-top: 32px;
            padding: 24px;
            background: #1a1a1a;
            border-radius: 16px;
            border: 1px solid #333;
        }

        .notification-settings h4 {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 16px;
        }

        .setting-item {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            padding: 12px 16px;
            border-radius: 12px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .setting-item:hover {
            background-color: #2a2a2a;
            transform: translateY(-1px);
        }

        .setting-item:last-child {
            margin-bottom: 0;
        }

        .setting-item input[type="checkbox"] {
            margin-right: 16px;
            width: 20px;
            height: 20px;
            accent-color: #ffffff;
            cursor: pointer;
        }

        .setting-item label {
            font-size: 16px;
            color: #ffffff;
            font-weight: 500;
            cursor: pointer;
            line-height: 1.4;
        }

        .back-btn:hover {
            background: #1a1a1a !important;
            border-color: #666 !important;
            transform: translateY(-1px);
        }

        .status-indicator {
            position: fixed;
            bottom: 32px;
            right: 32px;
            background: #000000;
            color: #ffffff;
            padding: 18px 28px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
            font-weight: 600;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
        }

        .pulse {
            width: 8px;
            height: 8px;
            background-color: #ffffff;
            border-radius: 50%;
            animation: pulse 1.5s infinite ease-in-out;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.5);
                opacity: 0.7;
            }
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .confirmation-title {
                font-size: 36px;
            }

            .confirmation-subtitle {
                font-size: 18px;
            }
        }

        @media (max-width: 768px) {
            .driver-confirmation-main {
                flex-direction: column;
                height: auto;
            }

            .confirmation-content {
                flex: none;
                height: auto;
                border-right: none;
            }

            .content-header {
                padding: 15px 30px;
            }

            .content-body {
                padding: 30px;
            }

            .map-section {
                flex: none;
                height: 60vh;
                /* Fixed height for map on mobile */
            }

            .action-buttons {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .content-header {
                padding: 15px 20px;
            }

            .content-body {
                padding: 20px;
            }

            .confirmation-title {
                font-size: 30px;
            }

            .confirmation-subtitle {
                font-size: 16px;
            }

            .privacy-notice {
                flex-direction: column;
                text-align: center;
                gap: 15px;
                padding: 20px;
            }

            .privacy-icon {
                width: 50px;
                height: 50px;
            }

            .privacy-notice p {
                font-size: 15px;
            }
        }

        /* ===== Driver Savings Card ===== */
        .driver-savings-card {
            background: linear-gradient(135deg, #1a1508 0%, #2a2210 100%);
            border: 1px solid rgba(255, 193, 7, 0.2);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 32px;
            position: relative;
            overflow: hidden;
        }

        .driver-savings-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 193, 7, 0.06) 0%, transparent 70%);
            pointer-events: none;
        }

        .savings-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .savings-label {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .savings-badge {
            background: rgba(255, 193, 7, 0.15);
            color: #FFC107;
            font-size: 12px;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 20px;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .savings-amount {
            display: flex;
            align-items: baseline;
            gap: 4px;
            margin-bottom: 4px;
        }

        .savings-currency {
            font-size: 22px;
            font-weight: 800;
            color: #FFC107;
        }

        .savings-value {
            font-size: 42px;
            font-weight: 900;
            color: #FFC107;
            line-height: 1;
            letter-spacing: -2px;
        }

        .savings-sublabel {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.4);
            margin-bottom: 20px;
        }

        .savings-benefits {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .savings-benefit-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .savings-benefit-row:hover {
            background: rgba(255, 255, 255, 0.07);
            transform: translateX(4px);
        }

        .savings-benefit-icon {
            font-size: 18px;
            width: 28px;
            text-align: center;
            flex-shrink: 0;
        }

        .savings-benefit-text {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.85);
            font-weight: 500;
            line-height: 1.3;
        }

        .savings-benefit-highlight {
            color: #FFC107;
            font-weight: 700;
        }

        .savings-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            gap: 10px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
        }

        .savings-loading .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 193, 7, 0.2);
            border-top-color: #FFC107;
            border-radius: 50%;
            animation: driverSpin 0.8s linear infinite;
        }

        @keyframes driverSpin {
            to {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 480px) {
            .savings-value {
                font-size: 36px;
            }
        }
    </style>
</head>

<body>
    <main class="driver-confirmation-main">
        <div class="confirmation-content">
            <div class="content-header">
                <nav class="navbar"
                    style="padding: 0; max-width: none; display: flex; justify-content: space-between; align-items: center;">
                    <div class="nav-brand">
                        <h2 style="color: #ffffff; font-size: 24px; font-weight: 700; margin: 0;">RideMate</h2>
                    </div>
                    <div class="nav-right">
                        <a href="index.html" class="back-btn"
                            style="color: #ffffff; font-weight: 600; text-decoration: none; padding: 10px 20px; border-radius: 8px; border: 1px solid #444; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px;">‚Üê
                            Back to Home</a>
                    </div>
                </nav>
            </div>

            <div class="content-body">
                <div class="success-icon">
                    <div class="checkmark">‚úì</div>
                </div>

                <h1 class="confirmation-title">Thank you for your contribution</h1>
                <p class="confirmation-subtitle">You'll get instant notifications when passengers want to travel along
                    your route.</p>

                <div class="privacy-notice">
                    <div class="privacy-icon">üîí</div>
                    <p>We will never disclose your final destination to passengers for your privacy.</p>
                </div>

                <div class="route-summary">
                    <h3>Your Route</h3>
                    <div class="route-details">
                        <div class="route-point">
                            <span class="route-icon route-start" style="color: #4CAF50;">‚óè</span>
                            <span class="route-text" id="start-location">Loading...</span>
                        </div>
                        <div class="route-line" style="height: 20px; width: 2px; background: #ddd; margin-left: 11px;">
                        </div>
                        <div class="route-point">
                            <span class="route-icon route-end" style="color: #f44336;">üìç</span>
                            <span class="route-text" id="end-location">Loading...</span>
                        </div>
                    </div>
                </div>

                <!-- Driver Savings Card -->
                <div class="driver-savings-card" id="driver-savings-card">
                    <div id="driver-savings-loading" class="savings-loading">
                        <div class="spinner"></div>
                        Calculating your fuel recovery...
                    </div>
                    <div id="driver-savings-content" style="display:none;">
                        <div class="savings-header">
                            <div>
                                <div class="savings-label">Fuel Cost Recovered</div>
                                <div class="savings-amount">
                                    <span class="savings-currency">‚Çπ</span>
                                    <span class="savings-value" id="driver-saved-amount">--</span>
                                </div>
                                <div class="savings-sublabel" id="driver-savings-sublabel">From fuel sharing on this
                                    trip</div>
                            </div>
                            <div class="savings-badge">üåü EARNED</div>
                        </div>
                        <div class="savings-benefits">
                            <div class="savings-benefit-row">
                                <span class="savings-benefit-icon">üëç</span>
                                <span class="savings-benefit-text" id="driver-msg">Same commute, lighter expense.</span>
                            </div>
                            <div class="savings-benefit-row">
                                <span class="savings-benefit-icon">üå±</span>
                                <span class="savings-benefit-text" id="driver-eco-msg">You helped someone skip a solo
                                    ride today.</span>
                            </div>
                            <div class="savings-benefit-row">
                                <span class="savings-benefit-icon">‚õΩ</span>
                                <span class="savings-benefit-text" id="driver-fuel-info">You‚Äôre not earning. You‚Äôre just
                                    driving smarter.</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="window.location.href='index.html'">
                        Create Another Trip
                    </button>
                    <button class="btn btn-primary" id="view-requests-btn">
                        View Passenger Requests
                    </button>
                </div>

                <div class="notification-settings">
                    <h4>üîî Notification Preferences</h4>
                    <div class="setting-item">
                        <input type="checkbox" id="instant-notifications" checked>
                        <label for="instant-notifications">Instant notifications for new requests</label>
                    </div>
                    <div class="setting-item">
                        <input type="checkbox" id="email-notifications">
                        <label for="email-notifications">Email summaries of your trips</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="map-section">
            <div id="map"></div>
            <div class="map-overlay">
                <div class="route-info">
                    <span id="route-distance">Calculating route...</span>
                    <span>‚Ä¢</span>
                    <span id="route-duration">Estimating time...</span>
                    <span>‚Ä¢</span>
                    <span id="route-status">Setting up your trip</span>
                </div>
            </div>
            <div class="status-indicator">
                <div class="pulse"></div>
                Searching for passengers nearby
            </div>
        </div>
    </main>

    <script>
        // Global variables for map and route
        let map;
        let olaMaps;
        let OLA_MAPS_API_KEY = '';
        let routeLayerAdded = false;
        let startLocation;
        let endLocation;

        // Store trip ID after creation
        let currentTripId = null;
        let routeDistance = null;
        let routeDuration = null;

        // üö® WEBSOCKET REAL-TIME NOTIFICATIONS üö®
        let socket = null;
        let isDriverConnected = false;
        let olaMapsAvailable = false; // Track if Ola Maps is working

        // Helper: Decode encoded polyline string to array of [lng, lat] for GeoJSON
        function decodePolyline(encoded) {
            const points = [];
            let index = 0, lat = 0, lng = 0;
            while (index < encoded.length) {
                let b, shift = 0, result = 0;
                do { b = encoded.charCodeAt(index++) - 63; result |= (b & 0x1f) << shift; shift += 5; } while (b >= 0x20);
                lat += ((result & 1) ? ~(result >> 1) : (result >> 1));
                shift = 0; result = 0;
                do { b = encoded.charCodeAt(index++) - 63; result |= (b & 0x1f) << shift; shift += 5; } while (b >= 0x20);
                lng += ((result & 1) ? ~(result >> 1) : (result >> 1));
                points.push([lng / 1e5, lat / 1e5]); // GeoJSON uses [lng, lat]
            }
            return points;
        }

        // Helper: Geocode coordinates to address using Ola Maps Reverse Geocode API
        async function reverseGeocode(lat, lng) {
            try {
                const resp = await fetch(`/api/maps/reverse-geocode?lat=${encodeURIComponent(lat)}&lng=${encodeURIComponent(lng)}`);
                const data = await resp.json();
                if (data.address) {
                    return data.address;
                }
            } catch (e) { console.error('Reverse geocode error:', e); }
            return `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
        }

        // Handle Ola Maps loading errors
        window.addEventListener('error', function (e) {
            if (e.message && (e.message.includes('OlaMaps') || e.message.includes('maplibregl'))) {
                showMapFallback('Unable to load Ola Maps. The app will continue with limited functionality.');
            }
        }, true);

        // Show fallback UI when map can't load
        function showMapFallback(message) {
            const mapElement = document.getElementById('map');
            if (mapElement) {
                mapElement.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); color: white; padding: 40px; text-align: center;">
                        <div style="font-size: 64px; margin-bottom: 20px;">üó∫Ô∏è</div>
                        <h3 style="font-size: 24px; margin-bottom: 16px; color: #fff;">Map Unavailable</h3>
                        <p style="font-size: 14px; color: rgba(255,255,255,0.7); max-width: 300px; line-height: 1.5; margin-bottom: 24px;">${message}</p>
                        <div style="background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 12px; padding: 16px 24px;">
                            <p style="font-size: 12px; color: #4CAF50; margin: 0;">Your trip is still active. Passengers will be able to find you.</p>
                        </div>
                    </div>
                `;
            }

            // Update route info overlay
            const routeDistanceEl = document.getElementById('route-distance');
            const routeDurationEl = document.getElementById('route-duration');
            if (routeDistanceEl) routeDistanceEl.textContent = 'Route info unavailable';
            if (routeDurationEl) routeDurationEl.textContent = 'Using local estimates';

            // Continue with app without map
            initializeAppWithoutMap();
        }

        // Initialize app when Ola Maps isn't available
        function initializeAppWithoutMap() {
            const urlParams = new URLSearchParams(window.location.search);
            startLocation = urlParams.get('start') || localStorage.getItem('startLocation') || 'Ahmedabad';
            endLocation = urlParams.get('end') || localStorage.getItem('endLocation') || 'Gandhinagar';

            document.getElementById('start-location').textContent = startLocation;
            document.getElementById('end-location').textContent = endLocation;

            // Use estimated distance (default 20km) for cost sharing
            const estimatedDistance = 20;
            fetchDriverCostSharing(estimatedDistance);

            // Initialize WebSocket connection
            initializeWebSocket();
            setupEventHandlers();
            checkAuthAndCreateTrip();
        }

        // Initialize the app with Ola Maps
        async function initializeApp() {
            console.log('Initializing RideMate app with Ola Maps...');

            // Fetch Ola Maps API key from server
            try {
                const configResp = await fetch('/api/config');
                const config = await configResp.json();
                OLA_MAPS_API_KEY = config.olaMapsApiKey || '';
            } catch (e) {
                console.error('Could not fetch config:', e);
            }

            const urlParams = new URLSearchParams(window.location.search);
            startLocation = urlParams.get('start') || localStorage.getItem('startLocation') || 'Ahmedabad';
            endLocation = urlParams.get('end') || localStorage.getItem('endLocation') || 'Gandhinagar';

            // Update UI with locations
            document.getElementById('start-location').textContent = startLocation;
            document.getElementById('end-location').textContent = endLocation;

            // Initialize WebSocket connection for real-time notifications
            initializeWebSocket();

            // Initialize Ola Maps
            initMap();

            // Setup event handlers
            setupEventHandlers();

            // Check authentication
            checkAuthAndCreateTrip();
        }

        // Initialize WebSocket connection for real-time notifications
        function initializeWebSocket() {
            try {
                socket = io();

                socket.on('connect', () => {
                    console.log('üöÄ WebSocket connected for real-time notifications');
                    updateStatusIndicator('Connected - ready for instant notifications');
                });

                socket.on('disconnect', () => {
                    console.log('‚ùå WebSocket disconnected');
                    updateStatusIndicator('Reconnecting...', 'error');
                });

                // Listen for instant passenger requests
                socket.on('passenger-request', (requestData) => {
                    console.log('üö® INSTANT NOTIFICATION: New passenger request!', requestData);
                    handleInstantPassengerRequest(requestData);
                });

                socket.on('driver-connected', (data) => {
                    console.log('‚úÖ Driver connected to trip room:', data);
                    isDriverConnected = true;
                    updateStatusIndicator('Live notifications active - passengers will see you instantly');
                });

            } catch (error) {
                console.error('Error initializing WebSocket:', error);
                // Fallback to polling if WebSocket fails
                console.log('Falling back to polling system...');
            }
        }

        // Handle instant passenger request via WebSocket
        function handleInstantPassengerRequest(requestData) {
            // Show instant notification
            showInstantNotification('New Ride Request! üéâ', `${requestData.passenger_name} wants to ride with you`);

            // Update status indicator
            updateStatusIndicator('New passenger request received!');

            // Show the beautiful modal immediately
            showPassengerRequestModal(requestData, requestData.earnings);

            // Play notification sound (optional)
            playNotificationSound();
        }

        // Show instant notification banner
        function showInstantNotification(title, message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(76, 175, 80, 0.4);
                z-index: 1004;
                max-width: 400px;
                text-align: center;
                animation: slideInDown 0.5s ease-out;
                border: 2px solid rgba(255, 255, 255, 0.2);
            `;

            const titleEl = document.createElement('div');
            titleEl.style.cssText = 'font-size: 18px; font-weight: 700; margin-bottom: 4px;';
            titleEl.textContent = title;

            const messageEl = document.createElement('div');
            messageEl.style.cssText = 'font-size: 14px; opacity: 0.9;';
            messageEl.textContent = message;

            notification.appendChild(titleEl);
            notification.appendChild(messageEl);

            document.body.appendChild(notification);

            // Add animation styles
            if (!document.getElementById('instant-notification-animations')) {
                const style = document.createElement('style');
                style.id = 'instant-notification-animations';
                style.textContent = `
                    @keyframes slideInDown {
                        from { 
                            transform: translateX(-50%) translateY(-100%); 
                            opacity: 0;
                        }
                        to { 
                            transform: translateX(-50%) translateY(0); 
                            opacity: 1;
                        }
                    }
                `;
                document.head.appendChild(style);
            }

            // Auto-remove after 4 seconds
            setTimeout(() => {
                notification.style.animation = 'slideInDown 0.5s ease-out reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 500);
            }, 4000);
        }

        // Play notification sound
        function playNotificationSound() {
            try {
                // Create a simple notification sound using Web Audio API
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (error) {
                console.log('Could not play notification sound:', error);
            }
        }

        async function checkAuthAndCreateTrip() {
            try {
                const response = await fetch('/api/auth/status');
                const data = await response.json();

                if (!data.isAuthenticated) {
                    showNotification('Please log in to create a trip', 'error');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    return;
                }

                // Check if driver already has an active trip
                const activeTripResponse = await fetch('/api/trips/active');
                const activeTripData = await activeTripResponse.json();

                if (activeTripData.hasActiveTrip) {
                    showExistingTripWarning(activeTripData.trip);
                }
            } catch (error) {
                console.log('Server not available, using demo mode');
                // Demo mode - continue without auth check
                // Check for demo user
                const demoUser = localStorage.getItem('demoUser');
                if (demoUser) {
                    showNotification('Demo mode: Trip created!', 'success');
                } else {
                    showNotification('Demo mode: View your route below', 'info');
                }
            }
        }

        function showExistingTripWarning(existingTrip) {
            // Create a modal to show the warning
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: #1a1a1a;
                border-radius: 16px;
                padding: 32px;
                max-width: 500px;
                width: 90%;
                border: 1px solid #333;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            `;

            modalContent.innerHTML = `
                <h2 style="color: #f44336; margin-bottom: 16px; font-size: 24px;">Active Trip Detected</h2>
                <p style="color: #ffffff; margin-bottom: 24px; line-height: 1.6;">
                    You already have an active trip from <strong>${existingTrip.start_location}</strong> to 
                    <strong>${existingTrip.end_location}</strong>.
                </p>
                <p style="color: #a0a0a0; margin-bottom: 32px;">
                    You can only have one active trip at a time. Please complete or cancel your current trip before creating a new one.
                </p>
                <div style="display: flex; gap: 16px;">
                    <button onclick="window.location.href='index.html'" style="
                        flex: 1;
                        padding: 12px 24px;
                        background: #333;
                        color: #ffffff;
                        border: none;
                        border-radius: 8px;
                        font-size: 16px;
                        cursor: pointer;
                        transition: all 0.2s;
                    ">Go Back</button>
                    <button onclick="cancelExistingTrip(${existingTrip.id})" style="
                        flex: 1;
                        padding: 12px 24px;
                        background: #f44336;
                        color: #ffffff;
                        border: none;
                        border-radius: 8px;
                        font-size: 16px;
                        cursor: pointer;
                        transition: all 0.2s;
                    ">Cancel Existing Trip</button>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }

        async function cancelExistingTrip(tripId) {
            try {
                const response = await fetch(`/api/trips/${tripId}/cancel`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    showNotification('Previous trip cancelled. Creating new trip...', 'success');
                    // Remove the modal
                    const modal = document.querySelector('div[style*="position: fixed"]');
                    if (modal) modal.remove();
                    // Proceed with creating the new trip
                    calculateRoute();
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Error cancelling trip', 'error');
                }
            } catch (error) {
                console.error('Error cancelling trip:', error);
                showNotification('Error cancelling trip. Please try again.', 'error');
            }
        }

        // Simple DOM ready check
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM ready, initializing Ola Maps...');
        });

        function initMap() {
            console.log('Initializing Ola Maps...');

            const mapElement = document.getElementById('map');
            if (!mapElement) {
                console.error('Map element not found!');
                return;
            }

            if (!OLA_MAPS_API_KEY || OLA_MAPS_API_KEY === 'your_ola_maps_api_key_here') {
                console.warn('Ola Maps API key not configured');
                showMapFallback('Ola Maps API key not configured. Please set OLA_MAPS_API_KEY in .env');
                return;
            }

            try {
                olaMaps = new OlaMapsSDK.OlaMaps({
                    apiKey: OLA_MAPS_API_KEY
                });

                map = olaMaps.init({
                    style: 'https://api.olamaps.io/tiles/vector/v1/styles/default-light-standard/style.json',
                    container: 'map',
                    center: [72.5714, 23.0225], // [lng, lat] for MapLibre
                    zoom: 13
                });

                olaMapsAvailable = true;

                map.on('load', () => {
                    console.log('Ola Map initialized successfully');
                    // Calculate and display route
                    calculateRoute();
                });

            } catch (error) {
                console.error('Error initializing map:', error);
                updateStatusIndicator('Error loading map', 'error');
                showMapFallback('Error initializing Ola Maps: ' + error.message);
            }
        }

        async function calculateRoute() {
            if (!startLocation || !endLocation) {
                console.error('Start or end location is missing.');
                updateStatusIndicator('Could not calculate route. Please try again.', 'error');
                return;
            }

            console.log('Calculating route from', startLocation, 'to', endLocation);

            try {
                // First geocode the location names to coordinates using Ola Autocomplete
                const startCoords = await geocodeLocationName(startLocation);
                const endCoords = await geocodeLocationName(endLocation);

                if (!startCoords || !endCoords) {
                    console.error('Could not geocode locations');
                    updateStatusIndicator('Could not find locations. Please try again.', 'error');
                    return;
                }

                // Call backend directions API (with provider fallback)
                const dirUrl = `/api/maps/directions?origin=${encodeURIComponent(`${startCoords.lat},${startCoords.lng}`)}&destination=${encodeURIComponent(`${endCoords.lat},${endCoords.lng}`)}`;
                const response = await fetch(dirUrl);
                const data = await response.json();

                if (!data.routes || data.routes.length === 0) {
                    console.error('No routes found');
                    updateStatusIndicator('No route found between locations.', 'error');
                    return;
                }

                const route = data.routes[0];
                const leg = route.legs[0];
                const encodedPolyline = route.overview_polyline || route.geometry;

                // Decode polyline to coordinates for map display
                const routeCoords = decodePolyline(encodedPolyline);

                // Draw route on map
                if (map.getSource('route')) {
                    map.getSource('route').setData({
                        type: 'Feature',
                        geometry: { type: 'LineString', coordinates: routeCoords }
                    });
                } else {
                    map.addSource('route', {
                        type: 'geojson',
                        data: {
                            type: 'Feature',
                            geometry: { type: 'LineString', coordinates: routeCoords }
                        }
                    });
                    map.addLayer({
                        id: 'route-line',
                        type: 'line',
                        source: 'route',
                        layout: { 'line-join': 'round', 'line-cap': 'round' },
                        paint: { 'line-color': '#1a73e8', 'line-width': 5, 'line-opacity': 1.0 }
                    });
                }

                // Store route details
                routeDistance = leg.distance / 1000; // Ola returns distance in meters
                routeDuration = Math.round(leg.duration / 60); // Ola returns duration in seconds

                // Update route info overlay
                document.getElementById('route-distance').textContent = routeDistance.toFixed(1) + ' km';
                document.getElementById('route-duration').textContent = routeDuration + ' mins';
                document.getElementById('route-status').textContent = 'Ready for passengers';

                // Fetch driver cost sharing
                fetchDriverCostSharing(routeDistance);

                // Add custom markers for start and end points
                createMarker(startCoords, 'Start', '#4CAF50');
                createMarker(endCoords, 'End', '#f44336');

                // Fit map to route bounds
                const bounds = new maplibregl.LngLatBounds();
                routeCoords.forEach(coord => bounds.extend(coord));
                map.fitBounds(bounds, { padding: 60 });

                // Create trip in database
                await createTripInDatabase(startCoords, endCoords, encodedPolyline);

                // Start checking for real passengers
                if (currentTripId) {
                    startPassengerSearch();
                }

            } catch (error) {
                console.error('Directions request failed:', error);
                updateStatusIndicator('Error calculating route. Please try again.', 'error');
            }
        }

        // Geocode a location name to coordinates using Ola Maps Autocomplete API
        async function geocodeLocationName(locationName) {
            try {
                const url = `/api/maps/geocode?query=${encodeURIComponent(locationName)}`;
                const response = await fetch(url);
                const data = await response.json();
                if (data.location && typeof data.location.lat === 'number' && typeof data.location.lng === 'number') {
                    return { lat: data.location.lat, lng: data.location.lng };
                }
                return null;
            } catch (e) {
                console.error('Geocode error for ' + locationName, e);
                return null;
            }
        }

        async function createTripInDatabase(startCoords, endCoords, encodedPolyline) {
            try {
                const tripData = {
                    start_location: startLocation,
                    end_location: endLocation,
                    start_lat: startCoords.lat,
                    start_lng: startCoords.lng,
                    end_lat: endCoords.lat,
                    end_lng: endCoords.lng,
                    distance_km: routeDistance,
                    duration_minutes: routeDuration,
                    route_polyline: encodedPolyline,
                    departure_time: new Date().toISOString()
                };

                const response = await fetch('/api/trips', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(tripData)
                });

                if (response.ok) {
                    const data = await response.json();
                    currentTripId = data.tripId;
                    console.log('Trip created with ID:', currentTripId);

                    // üö® JOIN WEBSOCKET ROOM FOR INSTANT NOTIFICATIONS üö®
                    if (socket && socket.connected) {
                        socket.emit('driver-join-trip', {
                            tripId: currentTripId,
                            userId: await getCurrentUserId()
                        });
                        console.log(`üîó Driver joined WebSocket room for trip ${currentTripId}`);
                    }

                    showNotification('Your trip has been created! You\'ll get instant notifications when passengers select you.', 'success');
                } else {
                    const error = await response.json();
                    throw new Error(error.message);
                }
            } catch (error) {
                console.error('Error creating trip:', error);
                showNotification('Error creating trip. Please try again.', 'error');
            }
        }

        // Get current user ID for WebSocket authentication
        async function getCurrentUserId() {
            try {
                const response = await fetch('/api/auth/status');
                const data = await response.json();
                return data.isAuthenticated ? data.user.id : null;
            } catch (error) {
                console.error('Error getting user ID:', error);
                return null;
            }
        }

        function createMarker(position, title, color) {
            if (!map || !olaMapsAvailable) return null;
            // Create a custom HTML element for the marker
            const el = document.createElement('div');
            el.style.width = '20px';
            el.style.height = '20px';
            el.style.borderRadius = '50%';
            el.style.backgroundColor = color;
            el.style.border = '3px solid white';
            el.style.boxShadow = '0 2px 6px rgba(0,0,0,0.3)';
            el.style.cursor = 'pointer';
            el.title = title;

            const marker = new maplibregl.Marker({ element: el })
                .setLngLat([position.lng, position.lat])
                .addTo(map);
            return marker;
        }

        // Fetch cost sharing data for driver
        async function fetchDriverCostSharing(distanceInKm) {
            try {
                const vehicleType = localStorage.getItem('vehicleType') || '4W';
                const fuelType = localStorage.getItem('fuelType') || 'petrol';
                const numPassengers = parseInt(localStorage.getItem('seatCount')) || 1;

                const response = await fetch('/api/cost-sharing/calculate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        distanceInKm: distanceInKm,
                        vehicleType: vehicleType,
                        fuelType: fuelType,
                        numberOfPassengers: numPassengers
                    })
                });

                if (!response.ok) throw new Error('API error');
                const data = await response.json();

                // Show the card
                document.getElementById('driver-savings-loading').style.display = 'none';
                document.getElementById('driver-savings-content').style.display = 'block';

                // The amount passengers will pay (= driver fuel recovery)
                document.getElementById('driver-saved-amount').textContent = data.passengerPool;
                document.getElementById('driver-savings-sublabel').textContent =
                    data.distanceInKm + ' km ¬∑ ' + data.fuelType + ' ¬∑ ' + data.vehicleType;

                // Driver messages
                document.getElementById('driver-msg').textContent = data.driverMessage;
                document.getElementById('driver-eco-msg').textContent = data.driverEcoMessage;
                document.getElementById('driver-fuel-info').innerHTML =
                    'Total fuel cost: <span class="savings-benefit-highlight">‚Çπ' + data.baseTripCost +
                    '</span> ¬∑ You absorb only <span class="savings-benefit-highlight">‚Çπ' +
                    (data.baseTripCost - data.passengerPool) + '</span>';

            } catch (error) {
                console.error('Driver cost sharing error:', error);
                document.getElementById('driver-savings-loading').style.display = 'none';
                document.getElementById('driver-savings-content').style.display = 'block';
                document.getElementById('driver-saved-amount').textContent = '--';
                document.getElementById('driver-msg').textContent = 'Same commute, lighter expense.';
                document.getElementById('driver-eco-msg').textContent = 'You helped reduce traffic today.';
                document.getElementById('driver-fuel-info').textContent = 'Cost details will appear when route loads.';
            }
        }

        function geocodeLocations() {
            // Geocoding is now handled by geocodeLocationName() using Ola Maps Autocomplete API
        }

        let passengerMarkers = [];
        let checkInterval = null;

        function startPassengerSearch() {
            // Clear any existing interval
            if (checkInterval) {
                clearInterval(checkInterval);
            }

            // Check for passengers immediately (for any existing requests)
            checkForPassengers();

            // With WebSocket, we get instant notifications
            // Keep minimal polling as backup every 5 minutes for reliability
            checkInterval = setInterval(checkForPassengers, 300000); // 5 minutes backup polling

            console.log('üöÄ Real-time WebSocket notifications active! You\'ll get instant alerts when passengers select you.');
            updateStatusIndicator('Live notifications active - passengers will see you instantly');
        }

        async function checkForPassengers() {
            if (!currentTripId) return;

            try {
                const response = await fetch(`/api/trips/${currentTripId}/requests`);
                if (response.ok) {
                    const requests = await response.json();
                    displayPassengerRequests(requests);
                }
            } catch (error) {
                console.error('Error checking for passengers:', error);
            }
        }

        function displayPassengerRequests(requests) {
            // Clear existing passenger markers
            passengerMarkers.forEach(marker => marker.remove());
            passengerMarkers = [];

            if (requests.length === 0) {
                updateStatusIndicator('Searching for passengers nearby');
                return;
            }

            updateStatusIndicator(`${requests.length} passenger${requests.length > 1 ? 's' : ''} found nearby`);

            requests.forEach((request, index) => {
                // Create custom SVG marker element
                const el = document.createElement('div');
                el.innerHTML = `<svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="16" cy="16" r="15" fill="#1a73e8" stroke="white" stroke-width="2"/>
                    <circle cx="16" cy="11" r="4" fill="white"/>
                    <path d="M16 17c-3.5 0-10 1.75-10 5.25V26h20v-3.75c0-3.5-6.5-5.25-10-5.25z" fill="white"/>
                </svg>`;
                el.style.cursor = 'pointer';
                el.title = `${request.passenger_name} - Pickup`;

                const passengerMarker = new maplibregl.Marker({ element: el })
                    .setLngLat([request.pickup_lng, request.pickup_lat])
                    .addTo(map);

                el.addEventListener('click', () => {
                    showRealPassengerInfo(request);
                });

                passengerMarkers.push(passengerMarker);
            });

            showNotification(`Found ${requests.length} passenger request${requests.length > 1 ? 's' : ''}!`, 'info');
        }

        function showRealPassengerInfo(request) {
            // Calculate driver earnings (86% of total fare)
            const driverEarnings = Math.round(request.fare_amount * 0.86);

            // Show the beautiful passenger request modal
            showPassengerRequestModal(request, driverEarnings);
        }

        function showPassengerRequestModal(request, driverEarnings) {
            // Remove any existing modal
            const existingModal = document.getElementById('passenger-request-modal');
            if (existingModal) {
                existingModal.remove();
            }

            // Create the modal
            const modal = document.createElement('div');
            modal.id = 'passenger-request-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: flex-end;
                justify-content: center;
                z-index: 10000;
                animation: modalFadeIn 0.3s ease-out;
            `;

            // Create the modal content
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: #1a1a1a;
                border-radius: 24px 24px 0 0;
                padding: 0;
                max-width: 500px;
                width: 100%;
                max-height: 80vh;
                overflow-y: auto;
                border: 1px solid #333;
                box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.5);
                animation: modalSlideUp 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                position: relative;
            `;

            modalContent.innerHTML = `
                <!-- Header -->
                <div style="padding: 24px 24px 16px 24px; border-bottom: 1px solid #333;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                        <h2 style="color: #ffffff; font-size: 24px; font-weight: 700; margin: 0;">
                            New Ride Request
                        </h2>
                        <button onclick="closePassengerModal()" style="
                            background: none;
                            border: none;
                            color: #888;
                            font-size: 24px;
                            cursor: pointer;
                            padding: 4px;
                            border-radius: 50%;
                            width: 32px;
                            height: 32px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            transition: all 0.2s;
                        " onmouseover="this.style.background='#333'; this.style.color='#fff';" 
                           onmouseout="this.style.background='none'; this.style.color='#888';">√ó</button>
                    </div>
                    <p style="color: #a0a0a0; margin: 0; font-size: 14px;">
                        A passenger wants to ride with you
                    </p>
                </div>

                <!-- Earnings Card -->
                <div style="padding: 24px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); margin: 0;">
                    <div style="text-align: center;">
                        <p style="color: rgba(255,255,255,0.9); margin: 0 0 8px 0; font-size: 16px; font-weight: 500;">
                            You'll Earn
                        </p>
                        <div style="color: #ffffff; font-size: 48px; font-weight: 900; margin: 0; line-height: 1;">
                            ‚Çπ${driverEarnings}
                        </div>
                        <p style="color: rgba(255,255,255,0.8); margin: 8px 0 0 0; font-size: 14px;">
                            (86% of ‚Çπ${request.fare_amount} total fare)
                        </p>
                    </div>
                </div>

                <!-- Passenger Info -->
                <div style="padding: 24px;">
                    <div style="background: #2a2a2a; border-radius: 16px; padding: 20px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
                            <div style="
                                width: 48px;
                                height: 48px;
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: white;
                                font-size: 20px;
                                font-weight: 600;
                            ">
                                ${request.passenger_name.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <h3 style="color: #ffffff; margin: 0; font-size: 18px; font-weight: 600;">
                                    ${request.passenger_name}
                                </h3>
                                <p style="color: #a0a0a0; margin: 4px 0 0 0; font-size: 14px;">
                                    Passenger
                                </p>
                            </div>
                        </div>
                        
                        <!-- Trip Details -->
                        <div style="space-y: 12px;">
                            <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px;">
                                <div style="
                                    width: 12px;
                                    height: 12px;
                                    background: #4CAF50;
                                    border-radius: 50%;
                                    margin-top: 6px;
                                    flex-shrink: 0;
                                "></div>
                                <div>
                                    <p style="color: #a0a0a0; margin: 0; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                                        PICKUP
                                    </p>
                                    <p style="color: #ffffff; margin: 4px 0 0 0; font-size: 16px; font-weight: 500;">
                                        ${request.pickup_location}
                                    </p>
                                </div>
                            </div>
                            
                            <div style="margin-left: 6px; width: 2px; height: 20px; background: #444;"></div>
                            
                            <div style="display: flex; align-items: flex-start; gap: 12px;">
                                <div style="
                                    width: 12px;
                                    height: 12px;
                                    background: #f44336;
                                    border-radius: 50%;
                                    margin-top: 6px;
                                    flex-shrink: 0;
                                "></div>
                                <div>
                                    <p style="color: #a0a0a0; margin: 0; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                                        DROPOFF
                                    </p>
                                    <p style="color: #ffffff; margin: 4px 0 0 0; font-size: 16px; font-weight: 500;">
                                        ${request.dropoff_location}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Trip Stats -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px;">
                        <div style="background: #2a2a2a; border-radius: 12px; padding: 16px; text-align: center;">
                            <p style="color: #a0a0a0; margin: 0; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                                DISTANCE
                            </p>
                            <p style="color: #ffffff; margin: 4px 0 0 0; font-size: 18px; font-weight: 600;">
                                ${(request.fare_amount / 3).toFixed(1)} km
                            </p>
                        </div>
                        <div style="background: #2a2a2a; border-radius: 12px; padding: 16px; text-align: center;">
                            <p style="color: #a0a0a0; margin: 0; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                                EST. TIME
                            </p>
                            <p style="color: #ffffff; margin: 4px 0 0 0; font-size: 18px; font-weight: 600;">
                                ${Math.round((request.fare_amount / 3) * 2)} min
                            </p>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 12px;">
                        <button onclick="declineRealPassenger(${request.id})" style="
                            flex: 1;
                            padding: 16px 24px;
                            background: #333;
                            color: #ffffff;
                            border: 2px solid #555;
                            border-radius: 12px;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.2s;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 8px;
                        " onmouseover="this.style.background='#444'; this.style.borderColor='#666';" 
                           onmouseout="this.style.background='#333'; this.style.borderColor='#555';">
                            <span>‚úï</span> Decline
                        </button>
                        <button onclick="acceptRealPassenger(${request.id})" style="
                            flex: 2;
                            padding: 16px 24px;
                            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
                            color: #ffffff;
                            border: none;
                            border-radius: 12px;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.2s;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 8px;
                            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(76, 175, 80, 0.4)';" 
                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(76, 175, 80, 0.3)';">
                            <span>‚úì</span> Accept Ride
                        </button>
                    </div>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Add CSS animations
            if (!document.getElementById('modal-animations')) {
                const style = document.createElement('style');
                style.id = 'modal-animations';
                style.textContent = `
                    @keyframes modalFadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes modalSlideUp {
                        from { 
                            transform: translateY(100%); 
                            opacity: 0;
                        }
                        to { 
                            transform: translateY(0); 
                            opacity: 1;
                        }
                    }
                    @keyframes modalSlideDown {
                        from { 
                            transform: translateY(0); 
                            opacity: 1;
                        }
                        to { 
                            transform: translateY(100%); 
                            opacity: 0;
                        }
                    }
                `;
                document.head.appendChild(style);
            }

            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closePassengerModal();
                }
            });

            // Auto-close after 30 seconds
            setTimeout(() => {
                if (document.getElementById('passenger-request-modal')) {
                    closePassengerModal();
                }
            }, 30000);
        }

        function closePassengerModal() {
            const modal = document.getElementById('passenger-request-modal');
            if (modal) {
                const modalContent = modal.querySelector('div');
                modalContent.style.animation = 'modalSlideDown 0.3s ease-in';
                modal.style.animation = 'modalFadeIn 0.3s ease-in reverse';
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        }

        async function acceptRealPassenger(matchId) {
            try {
                // Close the modal first for immediate feedback
                closePassengerModal();

                // Show loading notification
                showNotification('Processing your acceptance...', 'info');

                const response = await fetch(`/api/matches/${matchId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: 'accepted' })
                });

                if (response.ok) {
                    // Show success with earnings emphasis
                    showEarningsNotification('Ride Accepted! üéâ', 'You\'ll earn your share when the trip completes.', 'success');
                    updateStatusIndicator('Passenger accepted - preparing for pickup');

                    // Update the main UI to show accepted state
                    updateUIForAcceptedRide();

                    // Refresh passenger list
                    checkForPassengers();
                } else {
                    throw new Error('Failed to accept passenger');
                }
            } catch (error) {
                console.error('Error accepting passenger:', error);
                showNotification('Error accepting passenger. Please try again.', 'error');
            }
        }

        async function declineRealPassenger(matchId) {
            try {
                // Close the modal first for immediate feedback
                closePassengerModal();

                const response = await fetch(`/api/matches/${matchId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: 'rejected' })
                });

                if (response.ok) {
                    showNotification('Passenger request declined.', 'info');
                    // Refresh passenger list
                    checkForPassengers();
                } else {
                    throw new Error('Failed to decline passenger');
                }
            } catch (error) {
                console.error('Error declining passenger:', error);
                showNotification('Error declining passenger. Please try again.', 'error');
            }
        }

        function showEarningsNotification(title, message, type = 'success') {
            // Create a special earnings notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
                color: white;
                padding: 20px 24px;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(76, 175, 80, 0.3);
                z-index: 1003;
                max-width: 350px;
                animation: slideInRight 0.4s ease-out;
            `;

            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <div style="font-size: 18px; font-weight: 700;">${title}</div>
                </div>
                <div style="font-size: 14px; opacity: 0.9; line-height: 1.4;">${message}</div>
            `;

            document.body.appendChild(notification);

            // Add slide-in animation
            if (!document.getElementById('notification-animations')) {
                const style = document.createElement('style');
                style.id = 'notification-animations';
                style.textContent = `
                    @keyframes slideInRight {
                        from { 
                            transform: translateX(100%); 
                            opacity: 0;
                        }
                        to { 
                            transform: translateX(0); 
                            opacity: 1;
                        }
                    }
                `;
                document.head.appendChild(style);
            }

            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.4s ease-out reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 400);
            }, 4000);
        }

        function updateUIForAcceptedRide() {
            // Update the status indicator with a more prominent message
            const statusIndicator = document.querySelector('.status-indicator');
            if (statusIndicator) {
                statusIndicator.innerHTML = `
                    <div style="width: 8px; height: 8px; background-color: #4CAF50; border-radius: 50%; animation: pulse 1.5s infinite ease-in-out;"></div>
                    Ride accepted - passenger notified
                `;
                statusIndicator.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
            }

            // Update the main confirmation subtitle
            const subtitle = document.querySelector('.confirmation-subtitle');
            if (subtitle) {
                subtitle.textContent = 'Great! You have an active ride. The passenger has been notified.';
                subtitle.style.color = '#4CAF50';
            }
        }


        function setupEventHandlers() {
            const viewRequestsBtn = document.getElementById('view-requests-btn');
            if (viewRequestsBtn) {
                viewRequestsBtn.addEventListener('click', showPassengerRequestsModal);
            }

            // Clean up on page unload
            window.addEventListener('beforeunload', () => {
                if (checkInterval) {
                    clearInterval(checkInterval);
                }
            });
        }


        function showPassengerRequestsModal() {
            // Implement a modal to show passenger requests
            showNotification('Feature coming soon: View and manage passenger requests here.', 'info');
        }

        function updateStatusIndicator(message, type = 'info') {
            const statusIndicator = document.querySelector('.status-indicator');
            if (statusIndicator) {
                statusIndicator.textContent = message;
                statusIndicator.style.backgroundColor = type === 'error' ? '#f44336' : '#4CAF50';
            }
        }

        function showNotification(message, type = 'info') {
            // A simple notification mechanism
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.padding = '15px';
            notification.style.borderRadius = '8px';
            notification.style.color = 'white';
            notification.style.zIndex = '1002';
            notification.style.backgroundColor = type === 'error' ? '#d9534f' : (type === 'success' ? '#5cb85c' : '#5bc0de');
            document.body.appendChild(notification);
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 3000);
        }

        // Make functions globally accessible for inline event handlers
        window.acceptRealPassenger = acceptRealPassenger;
        window.declineRealPassenger = declineRealPassenger;
        window.cancelExistingTrip = cancelExistingTrip;
        window.closePassengerModal = closePassengerModal;
    </script>

    <!-- Socket.io for real-time notifications -->
    <script src="/socket.io/socket.io.js"></script>

    <!-- Ola Maps Web SDK (MapLibre GL JS based) -->
    <script src="https://www.unpkg.com/olamaps-web-sdk@latest/dist/olamaps-web-sdk.umd.js"></script>
    <link href="https://unpkg.com/maplibre-gl@4.x/dist/maplibre-gl.css" rel="stylesheet" />

    <!-- Initialize Ola Maps -->
    <script>
        // Initialize the app
        if (typeof initializeApp === 'function') {
            initializeApp();
        }
    </script>
</body>

</html>